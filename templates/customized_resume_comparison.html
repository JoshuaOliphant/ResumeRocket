{% extends "base.html" %}

{% block content %}
<!-- Warning for users with JavaScript disabled -->
<noscript>
    <div class="alert alert-danger">
        <strong>Warning:</strong> JavaScript is disabled in your browser. The diff highlighting and interactive features 
        of this comparison view require JavaScript to function properly. Please enable JavaScript or 
        <a href="{{ url_for('resume.view_customized_resume', resume_id=resume.id) }}">view the basic version</a> instead.
    </div>
</noscript>

<style>
/* Additional styles for diff view */
.diff-added {
    background-color: rgba(87, 171, 90, 0.15);
    color: #2e7d32;
    padding: 1px 0;
    border-radius: 2px;
}

.diff-removed {
    background-color: rgba(229, 83, 75, 0.15);
    color: #c62828;
    padding: 1px 0;
    border-radius: 2px;
}

/* Diff line classes */
.diff-line {
    @apply px-4 whitespace-pre-wrap break-words border-l-3 border-transparent;
}

.diff-line:hover {
    @apply bg-gray-100 dark:bg-gray-700;
}

.diff-marker {
    @apply inline-block w-5 text-gray-500 dark:text-gray-400 select-none;
}

.diff-context {
    @apply text-gray-700 dark:text-gray-300;
}

.diff-line.diff-added {
    @apply bg-green-50 dark:bg-green-900/20 border-l-accent-light rounded-none;
}

.diff-line.diff-added .diff-marker {
    @apply text-accent-dark dark:text-accent-light font-bold;
}

.diff-line.diff-removed {
    @apply bg-red-50 dark:bg-red-900/20 border-l-red-500 rounded-none no-underline;
}

.diff-line.diff-removed .diff-marker {
    @apply text-red-500 font-bold;
}

.diff-collapsed {
    @apply py-2 px-4 text-center bg-gray-100 dark:bg-gray-700 border-y border-gray-200 dark:border-gray-600 text-gray-500 dark:text-gray-400;
}

/* Search highlighting styles */
.search-highlight {
    @apply bg-accent-light/30 py-0.5 rounded shadow-sm;
}

.search-active-match {
    @apply bg-accent-light/60 py-0.5 rounded shadow relative z-10;
}

/* Pulsing animation for active match */
@keyframes matchPulse {
    0% { background-color: theme('colors.accent-light.DEFAULT / 0.6'); }
    50% { background-color: theme('colors.accent-light.DEFAULT / 0.4'); }
    100% { background-color: theme('colors.accent-light.DEFAULT / 0.6'); }
}

.search-match-pulse {
    animation: matchPulse 1.5s ease-in-out infinite;
}

/* Resume content styling */
.resume-content {
    @apply whitespace-pre-wrap font-sans leading-relaxed max-h-[600px] overflow-y-auto;
}

/* Print-specific styles */
@media print {
    /* Remove max-height constraints for printing */
    .resume-content, .section-content {
        max-height: none !important;
        overflow: visible !important;
        display: block !important;
        opacity: 1 !important;
    }
    
    /* Ensure diff highlighting is visible in print */
    .diff-added {
        background-color: rgba(var(--color-accent-light), 0.2) !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }
    
    .diff-removed {
        background-color: rgba(239, 68, 68, 0.2) !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }
    
    /* Add page break control */
    .page-break-after {
        page-break-after: always;
    }
}
</style>

<!-- Include the jsdiff library for diff generation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsdiff/5.1.0/diff.min.js"></script>

<div class="container mx-auto px-4 py-6" 
     x-data="resumeComparison({
        resumeId: {{ resume.id|default(0) }}, 
        originalScore: {{ resume.original_ats_score|default(0)|round(1) }},
        customizedScore: {{ resume.ats_score|default(0)|round(1) }},
        compareUrl: '{{ url_for('resume.compare_resume', resume_id=resume.id) }}',
        exportUrl: '{{ url_for('resume.export_resume', resume_id=resume.id, version='customized') }}'
     })">
    
    <!-- Header with Summary Section -->
    <div class="grid gap-6 mb-6">
        <div class="col-span-12">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden">
                <div class="bg-accent-dark text-white px-6 py-4">
                    <h2 class="text-xl font-bold">Resume Comparison</h2>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="md:col-span-2">
                            <!-- Search input -->
                            <div x-show="initialLoadComplete" x-html="searchTemplate"></div>
                        </div>
                        
                        <div class="md:col-span-1">
                            <div class="flex justify-end items-center mb-2">
                                <div class="flex flex-wrap gap-2">
                                    <span class="px-2.5 py-0.5 text-xs font-medium rounded bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-300">
                                        Original: {{ resume.original_ats_score|round(1) if resume else 'N/A' }}%
                                    </span>
                                    <span class="px-2.5 py-0.5 text-xs font-medium rounded bg-accent-light/80 text-white">
                                        New: {{ resume.ats_score|round(1) if resume else 'N/A' }}%
                                    </span>
                                    <span class="px-2.5 py-0.5 text-xs font-medium rounded bg-accent-light/60 text-white">
                                        {% if resume %}
                                            {% set improvement = resume.ats_score - resume.original_ats_score %}
                                            {% if improvement > 0 %}+{% endif %}{{ improvement|round(1) }}%
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                            <div id="change-summary" class="text-right">
                                <p class="mb-1 text-sm text-gray-700 dark:text-gray-300">
                                    Summary of changes: 
                                    <span id="changes-count" class="px-2 py-0.5 text-xs font-medium rounded-full bg-accent-light/70 text-white">
                                        {{ resume.changes_count if resume and resume.changes_count else '0' }} changes
                                    </span>
                                </p>
                                <div id="summary-details" class="text-xs text-gray-600 dark:text-gray-400">
                                    {% if resume and resume.comparison_data %}
                                        <span class="px-2 py-0.5 text-xs font-medium rounded-full bg-accent-light/80 text-white mr-1">
                                            {{ resume.comparison_data.new_keywords_count if resume.comparison_data.new_keywords_count else 0 }} keywords added
                                        </span>
                                        {% if resume.comparison_data.keyword_density %}
                                            <span class="px-2 py-0.5 text-xs font-medium rounded-full bg-accent-light/60 text-white">
                                                Density: {{ resume.comparison_data.keyword_density.original|round(2) }}% → {{ resume.comparison_data.keyword_density.new|round(2) }}%
                                            </span>
                                        {% endif %}
                                    {% else %}
                                        Changes will be highlighted in the comparison below.
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h5 class="text-lg font-medium text-gray-900 dark:text-white">Job Title: <span id="job-title" class="font-normal">{{ job.title if job else 'N/A' }}</span></h5>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Created: <span id="creation-date">{{ resume.created_at if resume else 'N/A' }}</span></p>
                        </div>
                        {% if resume and resume.comparison_data and resume.comparison_data.added_keywords %}
                        <div>
                            {% include "components/resume/section_collapsible.html" with {
                                "title": "Key Improvements",
                                "expanded": true,
                                "content": "
                                    <div class='grid grid-cols-1 md:grid-cols-2 gap-4'>
                                        <div>
                                            <span class='text-xs text-gray-600 dark:text-gray-400'>Added Keywords:</span>
                                            <div class='flex flex-wrap gap-1 mt-1'>
                                                {% for keyword in resume.comparison_data.added_keywords[:10] %}
                                                    <span class='px-2 py-0.5 text-xs font-medium rounded-full bg-accent-light/80 text-white'>{{ keyword }}</span>
                                                {% endfor %}
                                                {% if resume.comparison_data.added_keywords|length > 10 %}
                                                    <span class='px-2 py-0.5 text-xs font-medium rounded-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300'>+{{ resume.comparison_data.added_keywords|length - 10 }} more</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div>
                                            <span class='text-xs text-gray-600 dark:text-gray-400'>Section Improvements:</span>
                                            <div class='mt-1'>
                                                {% for section, data in resume.comparison_data.section_improvements.items() %}
                                                    {% if data.improvement > 0 %}
                                                        <div class='text-xs mb-1'>
                                                            {{ section|title }}: 
                                                            <span class='text-gray-600 dark:text-gray-400'>{{ data.original|round(1) }}</span> → 
                                                            <span class='text-accent-dark dark:text-accent-light'>{{ data.new|round(1) }}</span>
                                                            <span class='text-accent-light/90'>(+{{ data.improvement|round(1) }})</span>
                                                        </div>
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                "
                            } %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Resume Comparison Section -->
    <div class="grid gap-6 mb-6">
        <div class="col-span-12">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden">
                <div class="bg-accent-dark text-white px-6 py-4 flex justify-between items-center">
                    <h4 class="text-lg font-bold">Before & After</h4>
                    <div class="flex items-center space-x-2">
                        <div class="inline-flex rounded-md shadow-sm" role="group">
                            <button type="button" 
                                    class="px-3 py-1.5 text-xs font-medium rounded-lg"
                                    :class="viewType === 'side-by-side' ? 'bg-white text-accent-dark hover:bg-white/90 border border-white' : 'bg-transparent text-white hover:bg-white/10 border border-white'"
                                    @click="changeViewType('side-by-side')"
                                    id="side-by-side-view-btn">Side-by-Side</button>
                            <button type="button" 
                                    class="px-3 py-1.5 text-xs font-medium rounded-lg"
                                    :class="viewType === 'diff' ? 'bg-white text-accent-dark hover:bg-white/90 border border-white' : 'bg-transparent text-white hover:bg-white/10 border border-white'"
                                    @click="changeViewType('diff')"
                                    id="diff-view-btn">Diff View</button>
                        </div>
                        <!-- Export component -->
                        {% set resume_id = resume.id %}
                        {% include "components/resume/export_options.html" with context %}
                    </div>
                </div>
                <div class="p-6">
                    <!-- Content loading indicator -->
                    <div x-show="!initialLoadComplete" class="flex justify-center items-center py-12">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-accent-light"></div>
                        <span class="ml-3 text-gray-600 dark:text-gray-400">Loading comparison...</span>
                    </div>
                    
                    <!-- Content diff component -->
                    <div x-show="initialLoadComplete" x-html="contentTemplate" 
                         hx-get="{{ url_for('resume.compare_resume_content', resume_id=resume.id) }}"
                         hx-trigger="load"
                         hx-swap="outerHTML"
                         hx-indicator=".loading-indicator"></div>
                    
                    <!-- Hidden containers for raw content -->
                    <div id="original-resume" style="display: none;">
                        {% if resume and resume.original_content %}
                            {{ resume.original_content | safe }}
                        {% else %}
                            Sample original resume content - No content was provided.
                        {% endif %}
                    </div>
                    <div id="customized-resume" style="display: none;">
                        {% if resume and resume.customized_content %}
                            {{ resume.customized_content | safe }}
                        {% else %}
                            Sample customized resume content - No content was provided.
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Customization Details Section -->
    <div class="grid gap-6 mb-6 customization-details-section">
        <div class="col-span-12">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden">
                <div class="bg-accent-dark text-white px-6 py-4 flex justify-between items-center">
                    <h4 class="text-lg font-bold">Customization Details</h4>
                </div>
                <div class="p-6">
                    <div class="mb-6">
                        {% include "components/resume/section_collapsible.html" with {
                            "title": "Customization Notes",
                            "expanded": true,
                            "content": "
                                <div class='bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg p-4 text-gray-700 dark:text-gray-300'>
                                    {% if resume and resume.customization_notes %}
                                        {{ resume.customization_notes | safe }}
                                    {% else %}
                                        <p>No specific customization notes were provided for this resume.</p>
                                    {% endif %}
                                </div>
                            "
                        } %}
                    </div>
                    
                    <!-- Dynamic optimization details loaded via HTMX -->
                    <div id="optimization-details-container" 
                         class="mb-6"
                         hx-get="{{ url_for('resume.resume_optimization_details', resume_id=resume.id) }}"
                         hx-trigger="revealed"
                         hx-indicator="#optimization-loading">
                        
                        <!-- Loading indicator -->
                        <div id="optimization-loading" class="htmx-indicator">
                            <div class="bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg p-4">
                                <div class="flex items-center justify-center py-4">
                                    <svg class="animate-spin h-8 w-8 text-accent-dark" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    <span class="ml-3 text-gray-600 dark:text-gray-400 font-medium">Loading optimization details...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {% if resume and resume.user_rating is none %}
                        <div class="mt-6" id="feedback-section">
                            {% include "components/resume/section_collapsible.html" with {
                                "title": "Provide Feedback",
                                "expanded": true,
                                "content": "
                                    <div class='bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg p-4'>
                                        <form id='resume-feedback-form' class='space-y-4' hx-post='/api/feedback/{{ resume.id }}' hx-swap='none' hx-on::after-request='showFeedbackStatus($event)'>
                                            <div class='feedback-status'></div>
                                            
                                            <div>
                                                <label class='block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2'>How would you rate this customized resume?</label>
                                                    <div class='flex items-center space-x-4'>
                                                        <div class='flex items-center'>
                                                            <input type='radio' id='rating-1' name='rating' value='1' class='w-4 h-4 text-accent-light focus:ring-accent-light'>
                                                            <label for='rating-1' class='ml-2 text-sm text-gray-700 dark:text-gray-300'>1</label>
                                                        </div>
                                                        <div class='flex items-center'>
                                                            <input type='radio' id='rating-2' name='rating' value='2' class='w-4 h-4 text-accent-light focus:ring-accent-light'>
                                                            <label for='rating-2' class='ml-2 text-sm text-gray-700 dark:text-gray-300'>2</label>
                                                        </div>
                                                        <div class='flex items-center'>
                                                            <input type='radio' id='rating-3' name='rating' value='3' class='w-4 h-4 text-accent-light focus:ring-accent-light'>
                                                            <label for='rating-3' class='ml-2 text-sm text-gray-700 dark:text-gray-300'>3</label>
                                                        </div>
                                                        <div class='flex items-center'>
                                                            <input type='radio' id='rating-4' name='rating' value='4' class='w-4 h-4 text-accent-light focus:ring-accent-light'>
                                                            <label for='rating-4' class='ml-2 text-sm text-gray-700 dark:text-gray-300'>4</label>
                                                        </div>
                                                        <div class='flex items-center'>
                                                            <input type='radio' id='rating-5' name='rating' value='5' class='w-4 h-4 text-accent-light focus:ring-accent-light'>
                                                            <label for='rating-5' class='ml-2 text-sm text-gray-700 dark:text-gray-300'>5</label>
                                                        </div>
                                                    </div>
                                                    <div class='flex items-center text-xs text-gray-500 dark:text-gray-400 mt-1'>
                                                        <span class='flex-1 text-left'>Poor</span>
                                                        <span class='flex-1 text-center'>Average</span>
                                                        <span class='flex-1 text-right'>Excellent</span>
                                                    </div>
                                            </div>
                                            
                                            <div>
                                                <label for='feedback' class='block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2'>Additional Feedback</label>
                                                <textarea id='feedback' name='feedback' rows='4' class='w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-accent-light focus:border-accent-light' placeholder='Tell us what you think about the customized resume...'></textarea>
                                            </div>
                                            
                                            <div class='flex flex-col space-y-2'>
                                                <div class='flex items-center'>
                                                    <input type='checkbox' id='was_effective' name='was_effective' class='w-4 h-4 text-accent-light focus:ring-accent-light'>
                                                    <label for='was_effective' class='ml-2 text-sm text-gray-700 dark:text-gray-300'>This customization was effective for my job application</label>
                                                </div>
                                                <div class='flex items-center'>
                                                    <input type='checkbox' id='interview_secured' name='interview_secured' class='w-4 h-4 text-accent-light focus:ring-accent-light'>
                                                    <label for='interview_secured' class='ml-2 text-sm text-gray-700 dark:text-gray-300'>I secured an interview with this resume</label>
                                                </div>
                                                <div class='flex items-center'>
                                                    <input type='checkbox' id='job_secured' name='job_secured' class='w-4 h-4 text-accent-light focus:ring-accent-light'>
                                                    <label for='job_secured' class='ml-2 text-sm text-gray-700 dark:text-gray-300'>I secured a job with this resume</label>
                                                </div>
                                            </div>
                                            
                                            <div class='flex justify-end'>
                                                <button type='submit' class='inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-accent-dark hover:bg-accent-dark/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-accent-light'>
                                                    <svg xmlns='http://www.w3.org/2000/svg' class='h-4 w-4 mr-2' fill='none' viewBox='0 0 24 24' stroke='currentColor'>
                                                        <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M5 13l4 4L19 7' />
                                                    </svg>
                                                    Submit Feedback
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                "
                            } %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('resumeComparison', (params) => ({
        resumeId: params.resumeId || 0,
        originalScore: params.originalScore || 0,
        customizedScore: params.customizedScore || 0,
        compareUrl: params.compareUrl || '',
        exportUrl: params.exportUrl || '',
        viewType: 'side-by-side',
        initialLoadComplete: false,
        
        // Templates for dynamic content
        contentTemplate: '<div class="loading-indicator flex justify-center items-center py-12"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-accent-light"></div></div>',
        searchTemplate: document.getElementById('search-template') ? document.getElementById('search-template').innerHTML : '',
        
        init() {
            // HTMX event handling
            document.body.addEventListener('htmx:afterSwap', (event) => {
                if (event.detail.target.id === 'content-diff-component') {
                    this.initialLoadComplete = true;
                    console.log('Content loaded successfully');
                }
            });
            
            document.body.addEventListener('htmx:responseError', (event) => {
                console.error('Error loading content:', event.detail.xhr.status);
                this.contentTemplate = `
                    <div class="p-4 text-red-500 bg-red-50 dark:bg-red-900/20 rounded-md">
                        <p class="font-medium">Error loading comparison content</p>
                        <p class="text-sm mt-2">Please try refreshing the page or contact support if the problem persists.</p>
                    </div>
                `;
                this.initialLoadComplete = true;
            });
        },
        
        changeViewType(type) {
            this.viewType = type;
            
            // Find the content diff component and update its view
            const diffComponent = document.querySelector('#content-diff-component');
            if (diffComponent && diffComponent.__x) {
                // Use Alpine.js to update the component's view type
                diffComponent.__x.dataStack[0].viewType = type;
                diffComponent.__x.dataStack[0].renderView();
            } else {
                console.error('Content diff component not found or not initialized');
            }
        },
        
        showFeedbackStatus(event) {
            const status = event.detail.successful ? 'success' : 'error';
            const message = event.detail.successful ? 'Thank you for your feedback!' : 'Error submitting feedback. Please try again.';
            
            const statusDiv = document.querySelector('.feedback-status');
            if (statusDiv) {
                statusDiv.innerHTML = `
                    <div class="p-4 mb-4 rounded-md ${status === 'success' ? 'bg-green-50 dark:bg-green-900/20 text-green-800 dark:text-green-100' : 'bg-red-50 dark:bg-red-900/20 text-red-800 dark:text-red-100'}">
                        ${message}
                    </div>
                `;
                
                // Clear the status after 3 seconds if successful
                if (status === 'success') {
                    setTimeout(() => {
                        statusDiv.innerHTML = '';
                    }, 3000);
                    
                    // Reset the form
                    document.getElementById('resume-feedback-form').reset();
                }
            }
        }
    }));
});
</script>
{% endblock %}