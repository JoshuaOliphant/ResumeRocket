{% set container_id = container_id|default('htmx-error-' ~ range(1000, 9999) | random) %}
{% set auto_retry = auto_retry|default(true) %}
{% set max_retries = max_retries|default(3) %}
{% set retry_delay = retry_delay|default(2000) %}
{% set retry_backoff = retry_backoff|default(true) %}

<div id="{{ container_id }}"
     x-data="{ 
        showError: false,
        errorType: null,
        errorMessage: '',
        errorTitle: '',
        errorStatus: null,
        retryCount: 0,
        maxRetries: {{ max_retries }},
        retryDelay: {{ retry_delay }},
        retryBackoff: {{ retry_backoff }},
        element: null,
        trigger: null,
        
        handleError(event) {
            console.log('HTMX error in handler:', event);
            this.errorType = event.detail.xhr ? 'xhr' : 'network';
            this.errorStatus = event.detail.xhr ? event.detail.xhr.status : null;
            this.element = event.detail.elt;
            this.trigger = event.detail.triggerSpec ? event.detail.triggerSpec.trigger : null;
            
            // Extract error message
            try {
                if (event.detail.xhr && event.detail.xhr.responseText) {
                    try {
                        const response = JSON.parse(event.detail.xhr.responseText);
                        this.errorMessage = response.error || response.message || 'Unknown error';
                    } catch {
                        this.errorMessage = event.detail.xhr.responseText;
                    }
                } else {
                    this.errorMessage = 'Failed to connect to the server';
                }
            } catch (e) {
                this.errorMessage = 'An unknown error occurred';
            }
            
            // Set error title based on status code
            if (this.errorStatus) {
                if (this.errorStatus >= 500) {
                    this.errorTitle = 'Server Error';
                } else if (this.errorStatus === 404) {
                    this.errorTitle = 'Not Found';
                } else if (this.errorStatus === 403) {
                    this.errorTitle = 'Access Denied';
                } else if (this.errorStatus === 401) {
                    this.errorTitle = 'Authentication Required';
                } else if (this.errorStatus >= 400) {
                    this.errorTitle = 'Request Error';
                }
            } else {
                this.errorTitle = 'Connection Error';
            }
            
            // Show error unless we are auto-retrying and under max retries
            if (!{{ auto_retry }} || this.retryCount >= this.maxRetries) {
                this.showError = true;
            } else {
                this.retryRequest();
            }
        },
        
        retryRequest() {
            if (this.retryCount < this.maxRetries) {
                this.retryCount++;
                
                // Calculate delay with exponential backoff if enabled
                let delay = this.retryDelay;
                if (this.retryBackoff) {
                    delay = this.retryDelay * Math.pow(1.5, this.retryCount - 1);
                }
                
                // Show retry message
                this.errorMessage = `Retrying... (${this.retryCount}/${this.maxRetries})`;
                this.showError = true;
                
                // Try again after delay
                setTimeout(() => {
                    this.showError = false;
                    
                    // Trigger original request again if we have the element and trigger
                    if (this.element && this.trigger) {
                        htmx.trigger(this.element, this.trigger);
                    }
                }, delay);
            } else {
                this.errorMessage = `Failed after ${this.maxRetries} attempts. Please try again later.`;
                this.showError = true;
            }
        },
        
        manualRetry() {
            if (this.element && this.trigger) {
                // Reset retry count
                this.retryCount = 0;
                this.showError = false;
                
                // Trigger original request again
                htmx.trigger(this.element, this.trigger);
            } else {
                // Fallback to page reload if we can't retry
                window.location.reload();
            }
        }
     }"
     @htmx:responseError.window="handleError($event)"
     @htmx:sendError.window="handleError($event)"
     class="htmx-error-handler">

    <div x-show="showError" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-300"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="bg-red-50 dark:bg-red-900/40 border-l-4 border-red-500 p-4 rounded-md mb-4">
        <div class="flex">
            <div class="flex-shrink-0">
                <!-- Error icon based on error type -->
                <template x-if="errorStatus >= 500">
                    <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                </template>
                <template x-if="errorType === 'network'">
                    <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-2 0a6 6 0 11-12 0 6 6 0 0112 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zm-1 9a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                    </svg>
                </template>
                <template x-if="errorType !== 'network' && (!errorStatus || errorStatus < 500)">
                    <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                    </svg>
                </template>
            </div>
            <div class="ml-3 w-full">
                <h5 class="text-lg font-medium text-red-800 dark:text-red-200" x-text="errorTitle"></h5>
                <p class="text-red-700 dark:text-red-300 mt-1" x-text="errorMessage"></p>
                
                <div x-show="retryCount < maxRetries" class="mt-3 flex flex-wrap gap-2">
                    <button @click="manualRetry()" 
                            class="px-3 py-1 bg-red-100 dark:bg-red-800 hover:bg-red-200 dark:hover:bg-red-700 text-red-800 dark:text-red-100 rounded-md text-sm transition">
                        Retry Now
                    </button>
                    
                    <button @click="showError = false" 
                            class="px-3 py-1 bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-800 dark:text-gray-300 rounded-md text-sm transition">
                        Dismiss
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>