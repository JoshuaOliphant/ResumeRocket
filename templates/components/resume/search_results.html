<!-- Search results component -->
<div 
     @keydown.arrow-up.prevent="navigateToMatch(currentMatch - 1)"
     @keydown.arrow-down.prevent="navigateToMatch(currentMatch + 1)"
     @keydown.window="handleKeyNavigation($event)"
     tabindex="0"
     x-data="{ 
    currentMatch: 0,
    totalMatches: {{ results.total }},
    originalMatchesCount: {{ results.matches.original|length }},
    customizedMatchesCount: {{ results.matches.customized|length }},
    
    handleKeyNavigation(e) {
        // Only handle if search is active
        if (this.totalMatches === 0) return;
        
        // Handle arrow keys for navigation
        if (e.key === 'ArrowUp') {
            e.preventDefault();
            this.navigateToMatch(this.currentMatch - 1);
        } else if (e.key === 'ArrowDown') {
            e.preventDefault();
            this.navigateToMatch(this.currentMatch + 1);
        }
    },
    
    navigateToMatch(index) {
        if (this.totalMatches === 0) return;
        
        // Wrap around if out of bounds
        if (index < 0) index = this.totalMatches - 1;
        if (index >= this.totalMatches) index = 0;
        
        // Remove active class from current match
        const currentActive = document.querySelector('.search-highlight.search-active-match');
        if (currentActive) {
            currentActive.classList.remove('search-active-match', 'search-match-pulse');
        }
        
        // Determine which container to look in based on index
        let targetContainer, matchIndex;
        if (index < this.originalMatchesCount) {
            targetContainer = 'original-content';
            matchIndex = index;
        } else {
            targetContainer = 'customized-content';
            matchIndex = index - this.originalMatchesCount;
        }
        
        // Find the match element
        const matchElement = document.querySelector(`#${targetContainer} .search-highlight[data-match-index='${matchIndex}']`);
        
        if (matchElement) {
            // Add active class
            matchElement.classList.add('search-active-match', 'search-match-pulse');
            
            // Scroll into view
            matchElement.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center'
            });
            
            // Expand section if collapsed (for comparison view)
            const parentContent = matchElement.closest('.section-content');
            if (parentContent && window.getComputedStyle(parentContent).display === 'none') {
                const parentSection = parentContent.closest('.resume-section');
                if (parentSection) {
                    const toggleBtn = parentSection.querySelector('.section-toggle');
                    if (toggleBtn) toggleBtn.click();
                }
            }
            
            // Update the current match
            this.currentMatch = index;
        }
    },
    
    highlightOriginalContent() {
        const container = document.getElementById('original-content');
        if (container && '{{ highlighted.original|default('') }}') {
            container.innerHTML = `{{ highlighted.original|safe|default('') }}`;
        }
    },
    
    highlightCustomizedContent() {
        const container = document.getElementById('customized-content');
        if (container && '{{ highlighted.customized|default('') }}') {
            container.innerHTML = `{{ highlighted.customized|safe|default('') }}`;
        }
    },
    
    init() {
        // Apply highlighted content
        this.highlightOriginalContent();
        this.highlightCustomizedContent();
        
        // Navigate to first match if we have matches
        if (this.totalMatches > 0) {
            this.$nextTick(() => this.navigateToMatch(0));
        }
    }
}" 
class="search-results">
    <!-- Search results summary and navigation -->
    {% if results.error %}
        <div class="bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-500 p-3 rounded">
            <p class="text-sm text-yellow-700 dark:text-yellow-200">{{ results.error }}</p>
        </div>
    {% elif results.total == 0 %}
        <div class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded p-3">
            <p class="text-sm text-gray-700 dark:text-gray-300">No matches found for "{{ results.query }}"</p>
        </div>
    {% else %}
        <div class="bg-accent-light/10 dark:bg-accent-dark/20 border border-accent-light/30 dark:border-accent-light/20 rounded p-3 flex flex-col md:flex-row justify-between items-start md:items-center gap-2">
            <!-- Match count -->
            <div class="text-sm text-gray-700 dark:text-gray-300">
                <p>Found <span class="font-medium text-accent-dark dark:text-accent-light">{{ results.total }} match{{ 'es' if results.total != 1 else '' }}</span> for "{{ results.query }}"</p>
                <p class="text-xs">
                    {% if results.matches.original|length > 0 %}
                        <span class="inline-block mr-2">
                            Original: {{ results.matches.original|length }}
                        </span>
                    {% endif %}
                    {% if results.matches.customized|length > 0 %}
                        <span class="inline-block">
                            Customized: {{ results.matches.customized|length }}
                        </span>
                    {% endif %}
                </p>
            </div>
            
            <!-- Navigation controls -->
            <div class="flex items-center space-x-2">
                <span class="text-sm text-gray-600 dark:text-gray-400" x-text="`Match ${currentMatch + 1} of ${totalMatches}`"></span>
                
                <button @click="navigateToMatch(currentMatch - 1)"
                        :disabled="totalMatches <= 1"
                        class="p-1 rounded-md bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed"
                        aria-label="Previous match">
                    <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                </button>
                
                <button @click="navigateToMatch(currentMatch + 1)"
                        :disabled="totalMatches <= 1"
                        class="p-1 rounded-md bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed"
                        aria-label="Next match">
                    <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- Match context preview (optional) -->
        <div class="mt-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded p-3 overflow-auto max-h-40" x-show="totalMatches > 0">
            <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Match context:</p>
            <div class="space-y-1">
                {% set all_matches = results.matches.original + results.matches.customized %}
                {% for index, match in enumerate(all_matches) %}
                    <div x-show="currentMatch === {{ index }}" 
                         x-transition:enter="transition ease-out duration-200"
                         x-transition:enter-start="opacity-0"
                         x-transition:enter-end="opacity-100"
                         class="text-sm font-mono bg-gray-50 dark:bg-gray-700 p-2 rounded">
                        <span class="text-xs text-gray-500 dark:text-gray-400">
                            {{ 'Original' if index < results.matches.original|length else 'Customized' }}:
                        </span> 
                        {{ match.context|safe }}
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}
</div>

<!-- Apply CSS for search highlights -->
<style>
.search-highlight {
    @apply bg-yellow-200 dark:bg-yellow-500/40 px-0.5 rounded;
}

.search-active-match {
    @apply bg-accent-light/50 dark:bg-accent-dark/50 text-black dark:text-white shadow-sm;
}

@keyframes matchPulse {
    0%, 100% { background-color: theme('colors.accent-light.DEFAULT / 0.5'); }
    50% { background-color: theme('colors.accent-light.DEFAULT / 0.3'); }
}

.dark .search-match-pulse {
    animation: darkMatchPulse 1.5s ease-in-out infinite;
}

.search-match-pulse {
    animation: matchPulse 1.5s ease-in-out infinite;
}

@keyframes darkMatchPulse {
    0%, 100% { background-color: theme('colors.accent-dark.DEFAULT / 0.5'); }
    50% { background-color: theme('colors.accent-dark.DEFAULT / 0.3'); }
}
</style>