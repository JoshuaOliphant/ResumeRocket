{% comment %}
Content diff component for resume comparison
Parameters:
- original_content: Original content string
- customized_content: Customized content string
- view_type: 'side-by-side' or 'diff'
{% endcomment %}

<!-- Add required scripts if not loaded in the parent template -->
<script>
  if (typeof Diff === 'undefined') {
    document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/jsdiff/5.1.0/diff.min.js"><\/script>');
  }
</script>

<div id="content-diff-component" 
     x-data="contentDiff({ 
         original: `{{ original_content|default('')|replace('`', '')|e('js') }}`, 
         customized: `{{ customized_content|default('')|replace('`', '')|e('js') }}`,
         viewType: '{{ view_type|default('side-by-side') }}'
     })"
     x-init="initialize()">

  <!-- Side-by-Side View -->
  <div x-show="viewType === 'side-by-side'" class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- Original Content -->
    <div>
      <div class="border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden shadow-sm">
        <div class="bg-gray-200 dark:bg-gray-700 px-4 py-3 flex justify-between items-center">
          <h5 class="font-medium text-gray-900 dark:text-white">Original Resume</h5>
          <span class="px-2.5 py-0.5 text-xs font-medium rounded bg-white dark:bg-gray-600 text-gray-800 dark:text-gray-200">
            {{ original_score|default('N/A') }}%
          </span>
        </div>
        <div class="p-0">
          <div id="original-content-display" class="p-4 resume-content bg-white dark:bg-gray-800 text-gray-900 dark:text-white overflow-auto min-h-[500px]" x-html="originalHtml"></div>
        </div>
      </div>
    </div>
    
    <!-- Customized Content -->
    <div>
      <div class="border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden shadow-sm">
        <div class="bg-accent-light/20 dark:bg-accent-dark/20 px-4 py-3 flex justify-between items-center">
          <h5 class="font-medium text-accent-dark dark:text-accent-light">Customized Resume</h5>
          <span class="px-2.5 py-0.5 text-xs font-medium rounded bg-white dark:bg-gray-600 text-gray-800 dark:text-gray-200">
            {{ customized_score|default('N/A') }}%
          </span>
        </div>
        <div class="p-0">
          <div id="customized-content-display" class="p-4 resume-content bg-white dark:bg-gray-800 text-gray-900 dark:text-white overflow-auto min-h-[500px]" x-html="customizedHtml"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Diff View -->
  <div x-show="viewType === 'diff'" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden shadow-sm min-h-[400px] p-4" x-html="diffHtml"></div>

  <!-- Search overlay template -->
  <template id="search-template">
    <div class="relative flex items-center mb-4">
      <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-gray-500 dark:text-gray-400">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
      </div>
      <input type="text" id="resume-search-input" 
             class="w-full pl-10 pr-10 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-accent-light focus:border-accent-light" 
             placeholder="Search across both resume versions..." 
             @input="debounceSearch($event.target.value)"
             @keydown.enter="navigateSearch('next')"
             @keydown.shift.enter="navigateSearch('prev')"
             aria-label="Search resume content">
      <button id="clear-search-btn" 
              class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300"
              @click="clearSearch()">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    
    <div id="search-results-info" x-show="searchResults.totalMatches > 0" class="mb-4 flex items-center">
      <span id="search-count" class="px-2.5 py-0.5 bg-accent-light text-white text-xs font-medium rounded-full mr-2" 
            x-text="`${searchResults.totalMatches} ${searchResults.totalMatches === 1 ? 'match' : 'matches'}`"></span>
      <span class="text-sm text-gray-600 dark:text-gray-400">Navigate: </span>
      <button id="prev-match-btn" 
              class="px-2 py-1 mr-1 text-xs font-medium border border-gray-300 dark:border-gray-600 rounded text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 disabled:opacity-50" 
              :disabled="searchResults.totalMatches <= 1"
              @click="navigateSearch('prev')">
        <svg xmlns="http://www.w3.org/2000/svg" class="inline-block w-3 h-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
        </svg> 
        Previous
      </button>
      <button id="next-match-btn" 
              class="px-2 py-1 text-xs font-medium border border-gray-300 dark:border-gray-600 rounded text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 disabled:opacity-50" 
              :disabled="searchResults.totalMatches <= 1"
              @click="navigateSearch('next')">
        <svg xmlns="http://www.w3.org/2000/svg" class="inline-block w-3 h-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
        Next
      </button>
      <span id="match-position" class="ml-2 text-sm text-gray-600 dark:text-gray-400" 
            x-text="`Match ${searchResults.currentMatch + 1} of ${searchResults.totalMatches}`"></span>
    </div>
  </template>
</div>

<script>
  document.addEventListener('alpine:init', () => {
    Alpine.data('contentDiff', (params) => ({
      // State
      original: params.original || '',
      customized: params.customized || '',
      viewType: params.viewType || 'side-by-side',
      originalHtml: '',
      customizedHtml: '',
      diffHtml: '',
      searchTerm: '',
      searchTimeout: null,
      searchResults: {
        matches: [],
        totalMatches: 0,
        currentMatch: -1
      },

      // Initialization
      initialize() {
        this.cleanContent();
        this.renderView();
      },

      // Clean HTML content to get plain text
      cleanContent() {
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = this.original;
        this.original = tempDiv.textContent || tempDiv.innerText || '';
        
        tempDiv.innerHTML = this.customized;
        this.customized = tempDiv.textContent || tempDiv.innerText || '';
      },

      // Render the appropriate view
      renderView() {
        if (this.viewType === 'side-by-side') {
          this.renderSideBySideView();
        } else {
          this.renderDiffView();
        }
      },

      // Render side-by-side view with word-level diff
      renderSideBySideView() {
        // Apply word-by-word diff for more granular highlighting
        const wordDiff = Diff.diffWords(this.original, this.customized);
        
        // Build HTML with diff highlighting for both sides
        let originalHtml = '';
        let customizedHtml = '';
        
        wordDiff.forEach(part => {
          // Escape HTML to prevent tags from being rendered
          const escapedValue = this.escapeHtml(part.value);
          
          if (part.added) {
            // Added parts only show in customized
            customizedHtml += `<span class="diff-added">${escapedValue}</span>`;
          } else if (part.removed) {
            // Removed parts only show in original
            originalHtml += `<span class="diff-removed">${escapedValue}</span>`;
          } else {
            // Unchanged parts show in both
            originalHtml += escapedValue;
            customizedHtml += escapedValue;
          }
        });
        
        // Set the content with highlighting
        this.originalHtml = `<pre class="whitespace-pre-wrap font-mono text-sm leading-relaxed">${originalHtml}</pre>
          <div class="mt-4 pt-2 text-xs text-gray-600 dark:text-gray-400 border-t border-gray-200 dark:border-gray-700">
            <div class="flex items-center">
              <span class="inline-block w-3 h-3 mr-1 bg-red-100 dark:bg-red-900/20 border border-red-500"></span>
              <span class="text-red-500 dark:text-red-400">Removed content</span>
            </div>
          </div>`;
        
        this.customizedHtml = `<pre class="whitespace-pre-wrap font-mono text-sm leading-relaxed">${customizedHtml}</pre>
          <div class="mt-4 pt-2 text-xs text-gray-600 dark:text-gray-400 border-t border-gray-200 dark:border-gray-700">
            <div class="flex items-center">
              <span class="inline-block w-3 h-3 mr-1 bg-green-100 dark:bg-green-900/20 border border-green-500"></span>
              <span class="text-green-600 dark:text-green-400">Added content</span>
            </div>
          </div>`;
      },

      // Render unified diff view
      renderDiffView() {
        try {
          // Generate patch format diff
          const diffOutput = Diff.createPatch('resume', 
                                           this.original, 
                                           this.customized,
                                           'Original Resume', 
                                           'Customized Resume');
                                           
          // Convert the diff to HTML
          let diffHtml = '';
          const lines = diffOutput.split('\n').slice(5); // Skip the header lines
          
          lines.forEach(line => {
            if (!line) return;
            
            // Escape HTML
            const escapedLine = this.escapeHtml(line);
                  
            // Format based on line type
            if (line.startsWith('+')) {
              diffHtml += `<div class="diff-line diff-added"><span class="diff-marker">+</span>${escapedLine.slice(1)}</div>`;
            } else if (line.startsWith('-')) {
              diffHtml += `<div class="diff-line diff-removed"><span class="diff-marker">-</span>${escapedLine.slice(1)}</div>`;
            } else {
              diffHtml += `<div class="diff-line"><span class="diff-marker">&nbsp;</span>${escapedLine}</div>`;
            }
          });
          
          this.diffHtml = diffHtml;
        } catch (e) {
          console.error('Error rendering diff view:', e);
          this.diffHtml = `<p class="text-red-500 p-4">Error rendering diff: ${e.message}</p>`;
        }
      },

      // Switch between views
      switchView(viewType) {
        this.viewType = viewType;
        this.renderView();
      },

      // Handle search with debounce
      debounceSearch(term) {
        clearTimeout(this.searchTimeout);
        this.searchTimeout = setTimeout(() => {
          this.performSearch(term);
        }, 300);
      },

      // Perform search
      performSearch(term) {
        if (!term || term.length < 2) {
          this.clearSearch();
          return;
        }

        this.searchTerm = term;
        this.clearSearchHighlights();
        
        // Reset match data
        this.searchResults = {
          matches: [],
          totalMatches: 0,
          currentMatch: -1
        };

        const originalMatches = this.viewType === 'side-by-side' 
          ? this.findMatches(document.getElementById('original-content-display'), term)
          : [];
          
        const customizedMatches = this.viewType === 'side-by-side'
          ? this.findMatches(document.getElementById('customized-content-display'), term)
          : this.findMatches(document.querySelector('[x-html="diffHtml"]'), term);

        this.searchResults.matches = [...originalMatches, ...customizedMatches];
        this.searchResults.totalMatches = this.searchResults.matches.length;
        
        if (this.searchResults.totalMatches > 0) {
          this.navigateSearch('next');
        }
      },

      // Find all matches in an element
      findMatches(container, term) {
        if (!container || !term) return [];
        
        const matches = [];
        const regex = new RegExp(this.escapeRegExp(term), 'gi');
        const walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT);
        
        let node;
        while (node = walker.nextNode()) {
          const content = node.textContent;
          if (!content || !regex.test(content)) continue;
          
          regex.lastIndex = 0;
          let match;
          
          while ((match = regex.exec(content)) !== null) {
            matches.push({
              node: node,
              start: match.index,
              end: regex.lastIndex,
              text: match[0]
            });
          }
        }
        
        return matches;
      },

      // Navigate between search matches
      navigateSearch(direction) {
        if (this.searchResults.totalMatches === 0) return;
        
        // Update current match index
        if (direction === 'next') {
          this.searchResults.currentMatch = (this.searchResults.currentMatch + 1) % this.searchResults.totalMatches;
        } else {
          this.searchResults.currentMatch = (this.searchResults.currentMatch - 1 + this.searchResults.totalMatches) % this.searchResults.totalMatches;
        }
        
        // Remove current active highlight
        document.querySelectorAll('.search-active-match').forEach(el => {
          el.classList.remove('search-active-match', 'search-match-pulse');
        });
        
        // Get current match
        const match = this.searchResults.matches[this.searchResults.currentMatch];
        if (!match) return;
        
        // Create range for the match
        const range = document.createRange();
        range.setStart(match.node, match.start);
        range.setEnd(match.node, match.end);
        
        // Create highlight span
        const highlightSpan = document.createElement('span');
        highlightSpan.className = 'search-active-match search-match-pulse';
        
        // Wrap the match with the highlight
        range.surroundContents(highlightSpan);
        
        // Scroll into view
        highlightSpan.scrollIntoView({behavior: 'smooth', block: 'center'});
      },

      // Clear search highlights
      clearSearchHighlights() {
        document.querySelectorAll('.search-highlight, .search-active-match').forEach(el => {
          const parent = el.parentNode;
          if (parent) {
            parent.replaceChild(document.createTextNode(el.textContent), el);
            parent.normalize();
          }
        });
      },

      // Clear search
      clearSearch() {
        this.searchTerm = '';
        this.clearSearchHighlights();
        this.searchResults = {
          matches: [],
          totalMatches: 0,
          currentMatch: -1
        };
      },

      // Utility: Escape HTML
      escapeHtml(text) {
        if (!text) return '';
        return text
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      },

      // Utility: Escape RegExp special characters
      escapeRegExp(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      }
    }));
  });
</script>