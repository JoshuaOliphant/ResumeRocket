{% extends "base.html" %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-6">
    <div class="mb-8">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden border dark:border-gray-700">
            <div class="bg-accent-dark px-6 py-4 flex flex-col sm:flex-row justify-between items-center gap-4">
                <h1 class="text-2xl md:text-3xl font-bold text-black mb-0">Customizing Resume for {{ job.title }}</h1>
                <div>
                    {% if resume.streaming_progress > 0 and resume.streaming_progress < 100 %}
                    <div class="bg-gray-200 dark:bg-gray-700 rounded-full h-5 w-48">
                        <div id="progress-bar" class="bg-accent-dark h-5 rounded-full text-xs text-center text-black font-bold flex items-center justify-center" 
                             style="width: {{ resume.streaming_progress }}%"
                             hx-sse="swap:progress from:/api/resume-updates/{{ resume.id }}">
                            {{ resume.streaming_progress }}%
                        </div>
                    </div>
                    {% else %}
                    {% set orig_score = 0 if original.ats_score is none else original.ats_score %}
                    {% set new_score = 0 if resume.ats_score is none else resume.ats_score %}
                    {% set improvement = new_score - orig_score %}
                    <div class="flex gap-2">
                        <span class="px-3 py-1 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-full text-sm font-medium">
                            Original Score: {{ "%.1f"|format(orig_score) }}%
                        </span>
                        <span class="px-3 py-1 bg-green-200 dark:bg-green-700 text-green-800 dark:text-green-200 rounded-full text-sm font-medium">
                            New Score: {{ "%.1f"|format(new_score) }}%
                        </span>
                        <span class="px-3 py-1 bg-blue-200 dark:bg-blue-700 text-blue-800 dark:text-blue-200 rounded-full text-sm font-medium">
                            Improved: {% if improvement > 0 %}+{% endif %}{{ "%.1f"|format(improvement) }}%
                        </span>
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="p-6">
                <!-- Main streaming container with SSE connections -->
                <div id="streaming-container"
                     x-data="resumeCustomizationStreaming"
                     @htmx:sse-error="handleSseError()"
                     @htmx:sse-open="sseConnected = true"
                     @htmx:sse-disconnected="handleSseDisconnect()"
                     @htmx:sse-beforeRequest="handleSseBeforeRequest()">
                    
                    <!-- Customization Status -->
                    <div id="customization-status" class="mb-6">
                        {% include "components/resume/customization_status.html" with context %}
                    </div>
                    
                    <!-- Resume Content -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <!-- Original Resume -->
                        {% set title = "Original Resume" %}
                        {% set content = original.original_content %}
                        {% set content_id = "original-content" %}
                        {% include "components/resume/content_display.html" with context %}
                        
                        <!-- Customized Resume -->
                        {% set title = "Customized Resume" %}
                        {% set content = resume.customized_content %}
                        {% set content_id = "customized-content" %}
                        {% include "components/resume/content_display.html" with context %}
                    </div>
                    
                    <!-- Streaming Components - only visible if resume is a placeholder -->
                    {% if resume.is_placeholder %}
                        <!-- Progress Indicator -->
                        {% set resume_id = resume.id %}
                        {% set current_stage = resume.streaming_stage|default('initialization') %}
                        {% include "components/resume/progress_indicator.html" with context %}
                        
                        <!-- Streaming Analytics -->
                        {% include "components/resume/streaming_analytics.html" with context %}
                        
                        <!-- Streaming Recommendations -->
                        {% include "components/resume/streaming_recommendations.html" with context %}
                        
                        <!-- Streaming Implementation -->
                        {% include "components/resume/streaming_implementation.html" with context %}
                        
                        <!-- Streaming Results -->
                        {% include "components/resume/streaming_results.html" with context %}
                    {% endif %}
                    
                    <!-- Optimization Details - loaded dynamically with HTMX -->
                    <div id="optimization-details" 
                         class="mb-6" 
                         style="display: {% if resume.is_placeholder %}none{% else %}block{% endif %};"
                         hx-get="{{ url_for('resume.resume_optimization_details', resume_id=resume.id) }}"
                         hx-trigger="{% if not resume.is_placeholder %}load{% else %}revealed{% endif %}"
                         hx-indicator="#optimization-loading">
                        
                        <!-- Loading indicator -->
                        <div id="optimization-loading" class="htmx-indicator">
                            <div class="bg-gray-800 dark:bg-gray-900 border border-gray-700 rounded-lg overflow-hidden p-6">
                                <div class="flex items-center justify-center py-4">
                                    <svg class="animate-spin h-8 w-8 text-accent-dark" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    <span class="ml-3 text-gray-300 font-medium">Loading optimization details...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex justify-between items-center mt-6">
                        <div>
                            <a href="{{ url_for('dashboard.user_dashboard') }}" 
                               class="px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md inline-flex items-center">
                                <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9.707 14.707a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 1.414L7.414 9H15a1 1 0 110 2H7.414l2.293 2.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                                </svg>
                                Back to Dashboard
                            </a>
                        </div>
                        
                        <div id="actions-container" style="display: {% if resume.is_placeholder %}none{% else %}flex{% endif %};" class="space-x-3">
                            <button onclick="window.print()" 
                                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md inline-flex items-center">
                                <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v2a2 2 0 002 2h6a2 2 0 002-2v-2h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd" />
                                </svg>
                                Print Resume
                            </button>
                            
                            <!-- Export Options -->
                            {% set resume_id = resume.id %}
                            {% include "components/resume/export_options.html" with context %}
                            
                            <a href="{{ url_for('resume.compare_resume', resume_id=resume.id) }}" 
                               class="px-4 py-2 bg-accent-dark hover:bg-opacity-90 text-black rounded-md inline-flex items-center">
                                <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                                </svg>
                                Compare View
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.markdown-content {
    white-space: pre-wrap;
    font-family: 'Source Sans Pro', sans-serif;
    line-height: 1.6;
    max-height: 500px;
    overflow-y: auto;
}

.streaming-status {
    animation: fade 1.5s infinite;
}

@keyframes fade {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
}
</style>

<!-- Alpine.js component for resume streaming -->
<script>
document.addEventListener('alpine:init', function() {
    Alpine.data('resumeCustomizationStreaming', function() {
        return {
            // State
            sseConnected: false,
            timeoutWarningShown: false,
            errorOccurred: false,
            reconnectAttempts: 0,
            maxReconnectAttempts: 3,
            connectionTimeout: null,
            
            // Initialize on component load
            init() {
                // Set fallback timeout for stuck processes
                this.connectionTimeout = setTimeout(() => {
                    this.checkTimeoutStatus();
                }, 60000); // 60 second timeout
                
                // Initialize restore on browser visibility change
                document.addEventListener('visibilitychange', () => {
                    if (!document.hidden && !this.sseConnected && this.reconnectAttempts < this.maxReconnectAttempts) {
                        this.handleReconnect();
                    }
                });
                
                // Handle page beforeunload to clean up
                window.addEventListener('beforeunload', () => {
                    this.cleanup();
                });
            },
            
            // Clean up when component is destroyed
            cleanup() {
                if (this.connectionTimeout) {
                    clearTimeout(this.connectionTimeout);
                }
            },
            
            // Called before SSE request is sent
            handleSseBeforeRequest() {
                console.log('SSE connection starting...');
                // Could add pre-connection setup here
            },
            
            // Handle SSE connection error
            handleSseError() {
                console.error('SSE connection error');
                if (!this.errorOccurred) {
                    this.errorOccurred = true;
                    
                    // Try to reconnect if under max attempts
                    if (this.reconnectAttempts < this.maxReconnectAttempts) {
                        this.reconnectAttempts++;
                        this.showReconnectingMessage();
                        setTimeout(() => {
                            this.handleReconnect();
                        }, 3000); // Wait 3 seconds before trying to reconnect
                    } else {
                        this.showErrorMessage('Connection error occurred and maximum reconnection attempts reached. Please refresh the page and try again.');
                    }
                }
            },
            
            // Handle SSE disconnection
            handleSseDisconnect() {
                console.warn('SSE connection disconnected');
                
                // Only handle if we haven't shown an error already
                if (!this.errorOccurred && this.sseConnected) {
                    this.sseConnected = false;
                    
                    // Try to reconnect if under max attempts
                    if (this.reconnectAttempts < this.maxReconnectAttempts) {
                        this.reconnectAttempts++;
                        this.showReconnectingMessage();
                        setTimeout(() => {
                            this.handleReconnect();
                        }, 2000); // Wait 2 seconds before trying to reconnect
                    } else {
                        this.showErrorMessage('Connection to the server was lost. Please refresh the page and try again.');
                    }
                }
            },
            
            // Handle reconnection attempt
            handleReconnect() {
                console.log(`Attempting reconnection (${this.reconnectAttempts}/${this.maxReconnectAttempts})...`);
                
                // Use HTMX to reconnect the SSE stream
                const sseElement = document.querySelector('[hx-sse="connect:/api/resume-updates/{{ resume.id }}"]');
                if (sseElement) {
                    // Dispatch the event to get HTMX to reconnect
                    htmx.trigger(sseElement, 'htmx:reconnect', {});
                }
            },
            
            // Check for timeout issues
            checkTimeoutStatus() {
                // Only apply fallback if still a placeholder
                const isPlaceholder = {{ 'true' if resume.is_placeholder else 'false' }};
                if (isPlaceholder && !this.timeoutWarningShown) {
                    console.warn('SSE timeout safety - checking if still processing');
                    
                    // Check if status message indicates an error already
                    const statusMessage = document.querySelector('.current-status');
                    if (statusMessage && !statusMessage.innerText.includes('Error') && 
                        !statusMessage.innerText.includes('Complete')) {
                        
                        this.timeoutWarningShown = true;
                        this.showTimeoutWarning();
                    }
                }
            },
            
            // Display reconnecting message
            showReconnectingMessage() {
                const statusMessage = document.querySelector('.current-status');
                if (statusMessage) {
                    statusMessage.innerHTML = `
                        <span class="streaming-status text-blue-700 dark:text-blue-300 font-medium">
                            Reconnecting to server... (Attempt ${this.reconnectAttempts}/${this.maxReconnectAttempts})
                        </span>
                        <svg class="animate-spin ml-2 h-4 w-4 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    `;
                }
            },
            
            // Display timeout warning
            showTimeoutWarning() {
                // Copy original content as fallback
                const originalContentElem = document.getElementById('original-content');
                const customizedContentElem = document.getElementById('customized-content');
                
                if (originalContentElem && customizedContentElem && originalContentElem.innerHTML) {
                    // Create fallback content
                    let fallbackContent = "<p><strong style='color:orange'>⚠️ Customization process timed out.</strong> <em>Below is your original resume content:</em></p>\n\n" + 
                                         originalContentElem.innerHTML;
                    
                    customizedContentElem.innerHTML = fallbackContent;
                    
                    // Show timeout warning
                    document.getElementById('customization-status').innerHTML = `
                        <div class="bg-red-50 dark:bg-red-900/40 border-l-4 border-red-500 p-4 rounded-md">
                            <div class="flex">
                                <div class="ml-3">
                                    <h5 class="text-lg font-medium text-red-800 dark:text-red-200">Customization Timeout</h5>
                                    <p class="text-red-700 dark:text-red-300 mt-1">
                                        The customization process took too long. You can try again later or continue with your original resume.
                                    </p>
                                    <div class="mt-3 flex space-x-3">
                                        <a href="{{ url_for('dashboard.user_dashboard') }}" class="px-3 py-1 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-md text-sm">
                                            Return to Dashboard
                                        </a>
                                        <a href="{{ url_for('resume.customize_resume', job_id=job.id) }}" class="px-3 py-1 bg-accent-dark text-black rounded-md text-sm">
                                            Try Again
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    
                    // Show action buttons
                    document.getElementById('actions-container').style.display = 'flex';
                }
            },
            
            // Display error message
            showErrorMessage(message) {
                document.getElementById('customization-status').innerHTML = `
                    <div class="bg-red-50 dark:bg-red-900/40 border-l-4 border-red-500 p-4 rounded-md">
                        <div class="flex">
                            <div class="ml-3">
                                <h5 class="text-lg font-medium text-red-800 dark:text-red-200">Connection Error</h5>
                                <p class="text-red-700 dark:text-red-300 mt-1">${message}</p>
                                <div class="mt-3 flex space-x-3">
                                    <a href="{{ url_for('dashboard.user_dashboard') }}" class="px-3 py-1 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-md text-sm">
                                        Return to Dashboard
                                    </a>
                                    <button onclick="window.location.reload()" class="px-3 py-1 bg-accent-dark text-black rounded-md text-sm">
                                        Refresh Page
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                
                // Copy original content as fallback
                const originalContentElem = document.getElementById('original-content');
                const customizedContentElem = document.getElementById('customized-content');
                
                if (originalContentElem && customizedContentElem && originalContentElem.innerHTML) {
                    // Create fallback content with error indication
                    let fallbackContent = "<p><strong style='color:red'>⚠️ Connection error occurred.</strong> <em>Below is your original resume content:</em></p>\n\n" + 
                                         originalContentElem.innerHTML;
                    
                    customizedContentElem.innerHTML = fallbackContent;
                }
            }
        };
    });
});
</script>

<!-- HTMX SSE Event Handlers -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle HTMX SSE events
    htmx.on('htmx:sseMessage', function(evt) {
        // Log all events for debugging
        console.log('SSE event received:', evt.detail.name);
        
        // Handle status events that update progress steps
        if (evt.detail.name === 'status-message') {
            const statusText = evt.detail.data;
            
            // Extract stage from status message to update progress tracker
            let stage = 'initialization';
            if (statusText.includes('Analyzing')) stage = 'analysis';
            else if (statusText.includes('Planning')) stage = 'planning';
            else if (statusText.includes('Implementing')) stage = 'implementation';
            else if (statusText.includes('Finalizing')) stage = 'final_analysis';
            else if (statusText.includes('Comparing')) stage = 'comparison';
            
            // Update the current stage in Alpine component
            const progressTracker = document.querySelector('.progress-tracker');
            if (progressTracker && progressTracker.__x) {
                progressTracker.__x.updateData('currentStage', stage);
            }
        }
        
        // Handle content events to update the resume content
        else if (evt.detail.name === 'content') {
            const customizedContentElement = document.getElementById('customized-content');
            if (customizedContentElement) {
                customizedContentElement.innerHTML = evt.detail.data;
            }
        }
        
        // Handle planning content - wrap in typed-text container if needed
        else if (evt.detail.name === 'planning') {
            const planningStream = document.getElementById('planning-stream');
            if (planningStream) {
                // If first chunk, create typed-text container
                if (!planningStream.querySelector('.typed-text')) {
                    planningStream.innerHTML = '<div class="typed-text"></div>';
                }
                
                // Append content to typed-text
                const typedText = planningStream.querySelector('.typed-text');
                if (typedText) {
                    typedText.innerHTML += evt.detail.data;
                    typedText.scrollTop = typedText.scrollHeight;
                }
            }
        }
        
        // Handle implementation content - wrap in typed-text container if needed
        else if (evt.detail.name === 'implementation') {
            const implementationStream = document.getElementById('implementation-stream');
            if (implementationStream) {
                // If first chunk, create typed-text container
                if (!implementationStream.querySelector('.typed-text')) {
                    implementationStream.innerHTML = '<div class="typed-text"></div>';
                }
                
                // Append content to typed-text
                const typedText = implementationStream.querySelector('.typed-text');
                if (typedText) {
                    typedText.innerHTML += evt.detail.data;
                    typedText.scrollTop = typedText.scrollHeight;
                }
            }
        }
        
        // Handle sections modified - show the list of modified sections
        else if (evt.detail.name === 'sections-modified') {
            const sectionsModified = document.getElementById('sections-modified');
            if (sectionsModified) {
                sectionsModified.style.display = 'block';
                const typedText = document.querySelector('#implementation-stream .typed-text');
                if (typedText) {
                    typedText.classList.add('complete');
                }
            }
        }
        
        // Handle completion events
        else if (evt.detail.name === 'complete') {
            document.getElementById('optimization-details').style.display = 'block';
            document.getElementById('actions-container').style.display = 'flex';
            
            // Mark all progress steps as completed
            const progressTracker = document.querySelector('.progress-tracker');
            if (progressTracker && progressTracker.__x) {
                progressTracker.__x.updateData('currentStage', 'comparison');
                
                // Mark all steps as completed
                document.querySelectorAll('.progress-step').forEach(step => {
                    step.classList.add('completed');
                    step.classList.remove('active');
                });
            }
        }
    });
    
    // When SSE connection closes unexpectedly
    htmx.on('htmx:sseStop', function(evt) {
        console.log('SSE connection stopped:', evt);
    });
});
</script>
{% endblock %}