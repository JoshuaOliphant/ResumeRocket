{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-6">
        <div class="card bg-dark border-secondary mb-4">
            <div class="card-header">
                <h5 class="card-title">Upload Resume</h5>
            </div>
            <div class="card-body">
                <form id="resumeForm" 
                      enctype="multipart/form-data"
                      hx-on:htmx:responseError="if(event.detail.xhr.status === 401) { window.location.href = '/auth/login'; }"
                      data-stream-form="true">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="resume_id" id="resume_id" value="">
                    <input type="hidden" name="job_id" id="job_id" value="">
                    <div class="mb-3">
                        <label class="form-label">Resume Upload Method</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="uploadType" id="textInput" value="text"
                                   hx-get="/partials/toggle-input?type=text"
                                   hx-target="#input-sections"
                                   hx-swap="innerHTML"
                                   hx-trigger="click">
                            <label class="form-check-label" for="textInput">
                                Enter Text (Markdown)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="uploadType" id="fileInput" value="file" checked
                                   hx-get="/partials/toggle-input?type=file"
                                   hx-target="#input-sections"
                                   hx-swap="innerHTML"
                                   hx-trigger="click">
                            <label class="form-check-label" for="fileInput">
                                Upload File (PDF, DOCX, MD)
                            </label>
                        </div>
                    </div>

                    <div id="input-sections">
                        <!-- Default to file input section -->
                        <div id="fileInputSection" class="mb-3">
                            <label for="resume_file" class="form-label">Resume File</label>
                            <input type="file" class="form-control" id="resume_file" name="resume_file" accept=".pdf,.docx,.md">
                            <small class="text-muted">Maximum file size: 5MB</small>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Job Description Input Method</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="jobDescriptionType" id="jobTextInput" value="text"
                                   hx-get="/partials/toggle-job-input?type=text"
                                   hx-target="#job-input-sections"
                                   hx-swap="innerHTML"
                                   hx-trigger="click">
                            <label class="form-check-label" for="jobTextInput">
                                Enter Text
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="jobDescriptionType" id="jobUrlInput" value="url" checked
                                   hx-get="/partials/toggle-job-input?type=url"
                                   hx-target="#job-input-sections"
                                   hx-swap="innerHTML"
                                   hx-trigger="click">
                            <label class="form-check-label" for="jobUrlInput">
                                Enter Job URL
                            </label>
                        </div>
                    </div>

                    <div id="job-input-sections">
                        <!-- Default to URL input section -->
                        <div id="jobUrlSection" class="mb-3">
                            <label for="jobUrl" class="form-label">Job Posting URL</label>
                            <input class="form-control" id="jobUrl" name="job_url" placeholder="https://...">
                            <small class="text-muted">Enter the full URL of the job posting (including https://)</small>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        {% if current_user.is_authenticated %}
                        <span class="spinner-border spinner-border-sm htmx-indicator" id="loading-indicator" role="status" aria-hidden="true"></span>
                        {% endif %}
                        {% if current_user.is_authenticated %}Analyze Job Description{% else %}Login to Analyze{% endif %}
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card bg-dark border-secondary">
            <div class="card-header">
                <h5 class="card-title">Analysis Results</h5>
            </div>
            <div id="results-content" class="card-body">
                {% if current_user.is_authenticated %}
                <!-- Results will be loaded here by streaming -->
                <div id="results-loading-placeholder" class="text-center d-none">
                    <div class="spinner-border my-5" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Analyzing your resume against the job description...</p>
                    <p class="text-muted">This may take 15-30 seconds</p>
                </div>
                {% else %}
                <!-- Login prompt for users who aren't authenticated -->
                <div class="text-center p-4">
                    <i class="bi bi-shield-lock display-4 mb-3"></i>
                    <h5>Login Required</h5>
                    <p>Please <a href="/auth/login">log in</a> or <a href="/auth/register">register</a> to analyze your resume.</p>
                    <div class="alert alert-info mt-3">
                        <p class="mb-0"><i class="bi bi-info-circle-fill me-2"></i>ResumeRocket helps you optimize your resume for specific job descriptions using advanced AI analysis.</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Streaming configuration element -->
        {% if current_user.is_authenticated %}
        <div id="streaming-config" 
             data-stream 
             data-stream-form="resumeForm"
             data-stream-endpoint="/api/stream_suggestions"
             data-stream-container="results-content"></div>
        {% endif %}
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('resumeForm');
        const resultsContent = document.getElementById('results-content');
        
        form.addEventListener('submit', function(e) {
            // Check if user is logged in
            {% if current_user.is_authenticated %}
                document.getElementById('results-loading-placeholder').classList.remove('d-none');
                // Let the form submit continue normally
            {% else %}
                e.preventDefault(); // Stop form submission
                
                // Show login required message
                resultsContent.innerHTML = `
                    <div class="alert alert-warning">
                        <h5>Login Required</h5>
                        <p>Please <a href="/auth/login" class="alert-link">log in</a> or <a href="/auth/register" class="alert-link">register</a> to analyze your resume.</p>
                        <p>Creating an account is free and allows you to save your resume and job descriptions for future use.</p>
                    </div>
                `;
            {% endif %}
        });
        
        // Initialize streaming only if user is authenticated
        {% if current_user.is_authenticated %}
            const streamingConfig = document.getElementById('streaming-config');
            if (streamingConfig) {
                setupStreamingElement(streamingConfig);
            }
        {% endif %}
    });
</script>
{% endblock %}